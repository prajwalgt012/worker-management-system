<!-- advance.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Advance Management</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="card">
    <h2>üí∞ Advance Management</h2>

    <label for="workerName">Select Worker:</label>
    <select id="workerName"></select>

    <label for="advanceAmount">Advance Amount:</label>
    <input type="number" id="advanceAmount" />

    <label for="reason">Reason:</label>
    <input type="text" id="reason" />

    <button onclick="giveAdvance()">‚ûï Give Advance</button>

    <hr />

    <h3>Manual Deduction</h3>
    <label for="deductWorkerName">Select Worker:</label>
    <select id="deductWorkerName"></select>

    <label for="deductAmount">Deduct Amount:</label>
    <input type="number" id="deductAmount" />

    <label for="deductReason">Reason:</label>
    <input type="text" id="deductReason" />

    <button onclick="deductAmountFromAdvance()">‚ûñ Deduct Amount</button>

    <p id="status"></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC3aue5Fg1Rpqk3rzkjQiQTBe76U6RA7GM",
      authDomain: "worker-management-50d6d.firebaseapp.com",
      projectId: "worker-management-50d6d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadWorkerNames() {
      const workers = await db.collection("workers").get();
      const nameSelect = document.getElementById("workerName");
      const deductSelect = document.getElementById("deductWorkerName");

      workers.forEach(doc => {
        const name = doc.data().name;
        const option1 = document.createElement("option");
        option1.value = name;
        option1.innerText = name;

        const option2 = option1.cloneNode(true);

        nameSelect.appendChild(option1);
        deductSelect.appendChild(option2);
      });
    }

    loadWorkerNames();

    async function giveAdvance() {
      const name = document.getElementById("workerName").value;
      const amount = parseFloat(document.getElementById("advanceAmount").value);
      const reason = document.getElementById("reason").value;

      const ref = db.collection("advances").doc(name);
      const doc = await ref.get();
      let data = {
        advanceAmount: amount,
        remainingBalance: amount,
        reason,
        cutHistory: [],
        status: "Active",
        createdAt: new Date()
      };

      if (doc.exists) {
        data = doc.data();
        data.advanceAmount += amount;
        data.remainingBalance += amount;
        data.reason += ", " + reason;
        data.status = "Active";
      }

      await ref.set(data);
      document.getElementById("status").innerText = "‚úÖ Advance Recorded";
    }

    async function deductAmountFromAdvance() {
      const name = document.getElementById("deductWorkerName").value;
      const amount = parseFloat(document.getElementById("deductAmount").value);
      const reason = document.getElementById("deductReason").value;

      const ref = db.collection("advances").doc(name);
      const doc = await ref.get();

      if (!doc.exists) {
        document.getElementById("status").innerText = "‚ùå No advance found.";
        return;
      }

      const data = doc.data();
      data.remainingBalance -= amount;
      data.cutHistory.push({ date: new Date(), amount, reason });

      if (data.remainingBalance <= 0) {
        data.status = "Cleared";
        data.remainingBalance = 0;
      }

      await ref.set(data);
      document.getElementById("status").innerText = "‚úÖ Amount Deducted";
    }
  </script>
</body>
</html>
