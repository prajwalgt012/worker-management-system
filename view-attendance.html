<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lu.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f4f6;
      padding: 20px;
      margin: 0;
    }
    h1, h2, h3 {
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
    }
    input[type="date"] {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    table th, table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    table th {
      background: #f0f0f0;
    }
    ul {
      list-style-type: none;
      padding-left: 0;
    }
    ul li {
      margin-bottom: 6px;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      table thead {
        display: none;
      }
      table td {
        padding: 8px;
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
      }
      table td::before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“… View Attendance</h1>
    <div style="margin: 20px 0;">
      <label>Start Date: <input type="date" id="startDate"></label>
      <label>End Date: <input type="date" id="endDate"></label>
      <button onclick="loadAttendance()">ğŸ” View</button>
    </div>

    <div id="attendanceTable"></div>
    <div id="summarySection" style="margin-top: 30px;"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJLo6CsZDiYrygv9huk0_BLHmQvkhRxxY",
      authDomain: "bams-social-app.firebaseapp.com",
      projectId: "bams-social-app",
      storageBucket: "bams-social-app.appspot.com",
      messagingSenderId: "542183068748",
      appId: "1:542183068748:web:c6beb38679a3026eae10e9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadAttendance() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!start || !end) return alert("âš ï¸ Please select both start and end dates.");

      const startDate = new Date(start);
      const endDate = new Date(end);
      if (startDate > endDate) return alert("âŒ Start date must be before end date.");

      const workersSnap = await db.collection("workers").get();
      const workers = {};
      workersSnap.forEach(doc => {
        workers[doc.id] = doc.data();
      });

      const attendanceSnap = await db.collection("attendance")
        .where("date", ">=", start)
        .where("date", "<=", end)
        .orderBy("date")
        .get();

      const records = [];
      attendanceSnap.forEach(doc => {
        const data = doc.data();
        if (data.status) {
          records.push(data);
        }
      });

      if (records.length === 0) {
        document.getElementById("attendanceTable").innerHTML = `<p style="text-align:center; color:gray;">ğŸ“­ No attendance data found for the selected range.</p>`;
        document.getElementById("summarySection").innerHTML = '';
        return;
      }

      let html = `<table>
        <thead>
        <tr>
          <th>Date</th>
          <th>Day</th>
          <th>Name</th>
          <th>Village</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody>`;

      const daySummary = {};
      const nameSummary = {};
      let totalFull = 0, totalHalf = 0, totalAbsent = 0;

      records.forEach(record => {
        const worker = workers[record.workerId];
        const status = record.status || "absent";
        const date = new Date(record.date);
        const dateStr = record.date;
        const day = date.toLocaleDateString('en-IN', { weekday: 'long' });
        const emoji = status === "full" ? "âœ… Full" : status === "half" ? "ğŸŒ“ Half" : "âŒ Absent";

        if (!daySummary[day]) daySummary[day] = { full: 0, half: 0, absent: 0 };
        daySummary[day][status]++;

        const name = worker?.name || "â“ Unknown";
        if (!nameSummary[name]) nameSummary[name] = { full: 0, half: 0, absent: 0 };
        nameSummary[name][status]++;

        if (status === "full") totalFull++;
        else if (status === "half") totalHalf++;
        else totalAbsent++;

        html += `<tr>
          <td data-label="Date">${dateStr}</td>
          <td data-label="Day">${day}</td>
          <td data-label="Name">${name}</td>
          <td data-label="Village">${worker?.village || '-'}</td>
          <td data-label="Status">${emoji}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById("attendanceTable").innerHTML = html;

      // Summary by Day
      let summaryHTML = `<h3>ğŸ“ˆ Summary by Day</h3><ul>`;
      for (const day in daySummary) {
        summaryHTML += `<li><b>${day}:</b> âœ… Full: ${daySummary[day].full}, ğŸŒ“ Half: ${daySummary[day].half}, âŒ Absent: ${daySummary[day].absent}</li>`;
      }
      summaryHTML += `</ul><h4>ğŸ“Š Grand Total:</h4>
        <ul>
          <li>âœ… Total Full: ${totalFull}</li>
          <li>ğŸŒ“ Total Half: ${totalHalf}</li>
          <li>âŒ Total Absent: ${totalAbsent}</li>
        </ul>`;

      // Summary by Name
      summaryHTML += `<h3>ğŸ‘¤ Worker-wise Summary</h3><ul>`;
      for (const name in nameSummary) {
        const entry = nameSummary[name];
        summaryHTML += `<li><b>${name}:</b> âœ… Full: ${entry.full}, ğŸŒ“ Half: ${entry.half}, âŒ Absent: ${entry.absent}</li>`;
      }
      summaryHTML += `</ul>`;

      document.getElementById("summarySection").innerHTML = summaryHTML;
    }
  </script>
</body>
</html>
