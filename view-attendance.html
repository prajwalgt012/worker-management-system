<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Attendance</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #ffffff;
      color: #000;
    }
    h2 {
      text-align: center;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .filters input {
      padding: 8px;
      font-size: 16px;
    }
    .filters button {
      padding: 10px 15px;
      background: black;
      color: white;
      border: none;
      cursor: pointer;
    }
    .summary, .results {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #000;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .filters {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <h2>ðŸ“Š Attendance Report</h2>

  <div class="filters">
    <label>From: <input type="date" id="startDate" /></label>
    <label>To: <input type="date" id="endDate" /></label>
    <button onclick="fetchAttendance()">Get Report</button>
    <button onclick="downloadPDF()">ðŸ“¥ Download PDF</button>
  </div>

  <div id="summary" class="summary"></div>
  <div id="results" class="results"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJLo6CsZDiYrygv9huk0_BLHmQvkhRxxY",
      authDomain: "bams-social-app.firebaseapp.com",
      projectId: "bams-social-app",
      storageBucket: "bams-social-app.appspot.com",
      messagingSenderId: "542183068748",
      appId: "1:542183068748:web:c6beb38679a3026eae10e9",
      measurementId: "G-40MHQ4M0X5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function convertToMMDDYY(dateStr) {
      const date = new Date(dateStr);
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const yy = String(date.getFullYear()).slice(2);
      return `${mm}/${dd}/${yy}`;
    }

    async function fetchAttendance() {
      const startInput = document.getElementById("startDate").value;
      const endInput = document.getElementById("endDate").value;
      if (!startInput || !endInput) return alert("Please select date range.");

      const start = convertToMMDDYY(startInput);
      const end = convertToMMDDYY(endInput);

      const snapshot = await db.collection("attendance").orderBy("date").get();

      const filteredData = snapshot.docs
        .map(doc => doc.data())
        .filter(entry => entry.date >= start && entry.date <= end);

      if (filteredData.length === 0) {
        document.getElementById("results").innerHTML = "ðŸ“­ No attendance data found for the selected range.";
        document.getElementById("summary").innerHTML = "";
        return;
      }

      const grouped = {};
      const dateWiseSummary = {};

      filteredData.forEach(entry => {
        const { name, date, attendance } = entry;
        if (!grouped[name]) grouped[name] = [];
        grouped[name].push({ date, attendance });

        if (!dateWiseSummary[date]) dateWiseSummary[date] = { full: 0, half: 0, absent: 0 };
        if (attendance === 'full') dateWiseSummary[date].full++;
        else if (attendance === 'half') dateWiseSummary[date].half++;
        else dateWiseSummary[date].absent++;
      });

      let html = "";
      for (const name in grouped) {
        html += `<h3>${name}</h3><table><tr><th>Date</th><th>Attendance</th></tr>`;
        grouped[name].forEach(e => {
          html += `<tr><td>${e.date}</td><td>${e.attendance}</td></tr>`;
        });
        html += `</table>`;
      }
      document.getElementById("results").innerHTML = html;

      let summaryHTML = `<h3>ðŸ“… Date-wise Summary</h3><table><tr><th>Date</th><th>Full</th><th>Half</th><th>Absent</th></tr>`;
      for (const date in dateWiseSummary) {
        const sum = dateWiseSummary[date];
        summaryHTML += `<tr><td>${date}</td><td>${sum.full}</td><td>${sum.half}</td><td>${sum.absent}</td></tr>`;
      }
      summaryHTML += `</table>`;
      document.getElementById("summary").innerHTML = summaryHTML;
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const summary = document.getElementById("summary").innerText;
      const results = document.getElementById("results").innerText;

      let y = 10;
      doc.setFontSize(12);
      doc.text("ðŸ“Š Attendance Report", 10, y);
      y += 10;

      summary.split("\n").forEach(line => {
        doc.text(line, 10, y);
        y += 7;
      });

      y += 10;

      results.split("\n").forEach(line => {
        if (y > 280) {
          doc.addPage();
          y = 10;
        }
        doc.text(line, 10, y);
        y += 7;
      });

      doc.save("Attendance_Report.pdf");
    }
  </script>
</body>
</html>
